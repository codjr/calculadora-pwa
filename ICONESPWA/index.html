<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Conversor de Imagens PWA</title>

  <!-- üß≠ Manifesto -->
  <link rel="manifest" href="manifest.webmanifest">

  <!-- üì± Compatibilidade iOS e Android -->
  <meta name="application-name" content="Conversor de Imagens">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Conversor">
  <link rel="apple-touch-icon" href="icons/imagem_icon_512x512.png">

  <!-- üé® Apar√™ncia e cor do tema -->
  <meta name="theme-color" content="#004aad">
  <meta name="background-color" content="#004aad">
  <meta name="description" content="PWA para converter e gerar √≠cones em m√∫ltiplos formatos e tamanhos.">
  <link rel="icon" type="image/png" href="icons/imagem_icon_192x192.png">

  <!-- üñºÔ∏è Splash Screen personalizada -->
  <style>
    :root {
      --cor-primaria: #004aad;
      --cor-primaria-hover: #003b8e;
      --cor-fundo: #f5f7fa;
      --cor-texto: #1f2937;
      --cor-card: #ffffff;
    }

    body {
      font-family: "Inter", "Segoe UI", sans-serif;
      background: var(--cor-fundo);
      color: var(--cor-texto);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      margin: 0;
      text-align: center;
    }

    h1 {
      color: var(--cor-primaria);
      margin-bottom: 1rem;
    }

    .card {
      background: var(--cor-card);
      padding: 1.5rem;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      max-width: 420px;
      width: 100%;
    }

    input[type="file"], select, input[type="number"], button {
      width: 100%;
      padding: 10px;
      margin: 0.5rem 0;
      border-radius: 8px;
      border: 1px solid #ccc;
    }

    button {
      background: var(--cor-primaria);
      color: #fff;
      cursor: pointer;
      transition: 0.3s;
    }

    button:hover {
      background: var(--cor-primaria-hover);
    }

    img {
      margin-top: 1rem;
      max-width: 100%;
      border-radius: 10px;
    }

    #progress {
      width: 100%;
      background: #e5e7eb;
      border-radius: 8px;
      height: 10px;
      margin-top: 10px;
      overflow: hidden;
      display: none;
    }

    #progress-bar {
      height: 100%;
      background: var(--cor-primaria);
      width: 0%;
      transition: width 0.3s ease;
    }

    footer {
      margin-top: 2rem;
      font-size: 0.85rem;
      opacity: 0.7;
    }

    /* Tela de Splash (mostrada ao abrir como app) */
    #splash {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: var(--cor-primaria);
      color: #fff;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      transition: opacity 0.5s ease;
    }

    #splash img {
      width: 120px;
      height: 120px;
      margin-bottom: 20px;
      animation: fadeIn 1s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: scale(0.9); }
      to { opacity: 1; transform: scale(1); }
    }
  </style>
</head>
<body>
  <!-- Splash Screen -->
  <div id="splash">
    <img src="icons/imagem_icon_192x192.png" alt="Logo PWA">
    <h2>Conversor de Imagens</h2>
    <p>Preparando o aplicativo...</p>
  </div>

  <h1>Conversor e Gerador de √çcones PWA</h1>

  <div class="card">
    <input type="file" id="upload" accept="image/*">

    <label for="format">Formato:</label>
    <select id="format">
      <option value="image/png">PNG</option>
      <option value="image/jpeg">JPG</option>
      <option value="image/webp">WEBP</option>
    </select>

    <label for="size">Tamanho:</label>
    <select id="size">
      <option value="original">Original</option>
      <option value="192">192√ó192</option>
      <option value="256">256√ó256</option>
      <option value="512">512√ó512</option>
      <option value="custom">Personalizado</option>
    </select>

    <div id="customSize" style="display:none;">
      <input type="number" id="customWidth" placeholder="Largura (px)">
      <input type="number" id="customHeight" placeholder="Altura (px)">
    </div>

    <button id="convertBtn">Converter e Baixar</button>
    <button id="generateAllBtn">Gerar √çcones PWA (48‚Äì512px)</button>

    <div id="progress">
      <div id="progress-bar"></div>
    </div>

    <div id="preview"></div>
  </div>

  <footer>üí° PWA reconhecido como WebAPK (instala√ß√£o autom√°tica opcional)</footer>

<script>
// Oculta a splash ap√≥s carregamento
window.addEventListener("load", () => {
  const splash = document.getElementById("splash");
  setTimeout(() => splash.style.opacity = "0", 700);
  setTimeout(() => splash.style.display = "none", 1200);
});

// Registro do Service Worker
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('service-worker.js')
    .then(() => console.log("‚úÖ Service Worker registrado com sucesso!"));
}

// Detecta o evento de instala√ß√£o (sem for√ßar prompt)
window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  window.deferredPrompt = e;
  console.log("üì± WebAPK detectado - o navegador decidir√° se exibe o prompt.");
});

const upload = document.getElementById("upload");
const format = document.getElementById("format");
const sizeSelect = document.getElementById("size");
const customSizeDiv = document.getElementById("customSize");
const preview = document.getElementById("preview");
const progress = document.getElementById("progress");
const progressBar = document.getElementById("progress-bar");
let currentImage = null;

sizeSelect.addEventListener("change", () => {
  customSizeDiv.style.display = sizeSelect.value === "custom" ? "block" : "none";
});

upload.addEventListener("change", (e) => {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = (event) => {
    const img = new Image();
    img.src = event.target.result;
    img.onload = () => {
      currentImage = img;
      preview.innerHTML = "";
      preview.appendChild(img);
    };
  };
  reader.readAsDataURL(file);
});

function converterEbaixar(img, formato, largura, altura, nomeExtra = "") {
  const canvas = document.createElement("canvas");
  canvas.width = largura;
  canvas.height = altura;
  const ctx = canvas.getContext("2d");
  ctx.drawImage(img, 0, 0, largura, altura);
  const base64 = canvas.toDataURL(formato);
  const a = document.createElement("a");
  a.href = base64;
  a.download = `imagem${nomeExtra}_${largura}x${altura}.${formato.split("/")[1]}`;
  a.click();
}

document.getElementById("convertBtn").addEventListener("click", () => {
  if (!currentImage) return alert("Selecione uma imagem primeiro!");
  let width = currentImage.width, height = currentImage.height;
  if (sizeSelect.value !== "original") {
    if (sizeSelect.value === "custom") {
      width = parseInt(document.getElementById("customWidth").value) || width;
      height = parseInt(document.getElementById("customHeight").value) || height;
    } else {
      width = height = parseInt(sizeSelect.value);
    }
  }
  converterEbaixar(currentImage, format.value, width, height);
});

document.getElementById("generateAllBtn").addEventListener("click", async () => {
  if (!currentImage) return alert("Selecione uma imagem primeiro!");
  const tamanhos = [48, 72, 96, 128, 144, 152, 192, 256, 384, 512];
  const formato = "image/png";
  progress.style.display = "block";
  progressBar.style.width = "0%";
  for (let i = 0; i < tamanhos.length; i++) {
    const tamanho = tamanhos[i];
    converterEbaixar(currentImage, formato, tamanho, tamanho, `_icon`);
    progressBar.style.width = ((i + 1) / tamanhos.length) * 100 + "%";
    await new Promise(r => setTimeout(r, 200));
  }
  setTimeout(() => {
    progress.style.display = "none";
    alert("üéâ Todos os √≠cones foram gerados!");
  }, 500);
});
</script>
</body>
</html>
